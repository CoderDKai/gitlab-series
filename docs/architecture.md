# GitLab 系列全栈架构文档

## 1. 引言

本文档概述了 GitLab 系列辅助工具套件的完整架构。该套件旨在通过**半自动化**方式优化企业 GitLab 工作流，在提高效率的同时保留用户的控制权。

**核心理念：**
- 🎯 **半自动化**：辅助而非替代，用户保持最终决策权
- 🚀 **渐进式采用**：从油猴脚本开始，按需扩展到其他端点
- 💾 **本地优先**：数据存储在本地，通过 JSON 导入/导出实现配置共享
- 🔧 **实用主义**：解决日常痛点，不过度设计

### 1.1 项目范围
- **第一阶段**：油猴脚本（Tampermonkey）- MR 增强功能
- **未来扩展**：浏览器扩展、VSCode 扩展、桌面应用

### 1.2 技术决策
- **Monorepo 架构**：使用 pnpm workspace 管理代码
- **共享包策略**：提取公共逻辑到 @coderdkai/gitlab-* 包
- **数据管理**：本地存储 + JSON 配置导入/导出

### 1.3 起始模板或现有项目
**状态：** 不适用 - 全新项目

这是一个使用 pnpm workspace 架构管理多个应用和共享包的新 monorepo 项目。

### 1.4 变更日志

| 日期 | 版本 | 描述 | 作者 |
|------|---------|-------------|--------|
| 2024-12-19 | v1.0 | 初始架构文档创建 | Winston（架构师）|

## 2. 高层架构

### 2.1 技术摘要

GitLab 系列采用**渐进式客户端架构**，通过 monorepo 管理多个独立但共享核心逻辑的客户端应用。首期聚焦油猴脚本实现快速价值交付，后续扩展到浏览器扩展、VSCode 扩展和桌面应用。所有端点共享 GitLab API 封装、缓存策略和工具函数，通过 pnpm workspace 实现代码复用。架构强调半自动化理念，在提升效率的同时保留用户控制权，采用本地存储策略配合 JSON 导入/导出实现配置共享。

### 2.2 平台和基础设施选择

**平台：** 纯客户端架构
**关键服务：** 无需云服务，所有逻辑在客户端执行
**部署方式：** 
- 油猴脚本：Greasy Fork 发布
- 浏览器扩展：Chrome/Edge Web Store
- VSCode 扩展：VS Code Marketplace
- 桌面应用：GitHub Releases

### 2.3 仓库结构

**结构：** Monorepo
**Monorepo 工具：** pnpm workspace
**包组织策略：** 
- `apps/*` - 各端应用
- `packages/*` - 共享包
- 每个包独立构建和版本管理

### 2.4 高层架构图

```mermaid
graph TB
    subgraph "用户入口"
        U1[GitLab 网页]
        U2[VSCode 编辑器]
        U3[桌面环境]
    end
    
    subgraph "应用层"
        A1[油猴脚本]
        A2[浏览器扩展]
        A3[VSCode 扩展]
        A4[桌面应用]
    end
    
    subgraph "共享包层"
        P1[@coderdkai/gitlab-api]
        P2[@coderdkai/gitlab-cache]
        P3[@coderdkai/gitlab-utils]
        P4[@coderdkai/gitlab-types]
    end
    
    subgraph "外部系统"
        G[GitLab API]
        S[本地存储]
    end
    
    U1 --> A1
    U1 --> A2
    U2 --> A3
    U3 --> A4
    
    A1 --> P1
    A1 --> P2
    A1 --> P3
    A1 --> P4
    
    A2 --> P1
    A2 --> P2
    A2 --> P3
    A2 --> P4
    
    A3 --> P1
    A3 --> P3
    A3 --> P4
    
    A4 --> P1
    A4 --> P2
    A4 --> P3
    A4 --> P4
    
    P1 --> G
    P2 --> S
    
    style A1 fill:#90EE90
    style P1 fill:#87CEEB
    style P2 fill:#87CEEB
    style P3 fill:#87CEEB
    style P4 fill:#87CEEB
```

### 2.5 架构模式

- **Monorepo 模式：** 统一代码管理，便于共享和重构 - *理由：* 最大化代码复用，统一版本管理
- **分层架构：** 应用层、共享包层、外部接口层清晰分离 - *理由：* 关注点分离，便于维护和测试
- **适配器模式：** 统一的 GitLab API 适配器屏蔽版本差异 - *理由：* 应对不同 GitLab 版本的 API 差异
- **本地优先模式：** 数据存储在客户端，无需服务器 - *理由：* 保护隐私，降低运维成本
- **渐进增强模式：** 从简单功能开始，逐步添加高级特性 - *理由：* 快速交付价值，降低风险
- **插件化架构：** 每个端点独立但共享核心 - *理由：* 灵活部署，按需使用

## 3. 技术栈

这是整个项目的**权威技术选择**。所有开发必须使用这些确切版本。

### 技术栈表

| 类别 | 技术 | 版本 | 用途 | 选择理由 |
|------|------|------|------|----------|
| 前端语言 | TypeScript | 5.3+ | 所有客户端开发 | 类型安全，更好的 IDE 支持 |
| 油猴框架 | Tampermonkey API | - | 油猴脚本开发 | 最广泛支持的用户脚本管理器 |
| 扩展框架 | Plasmo | 0.84+ | 浏览器扩展开发 | 现代化的扩展开发框架 |
| VSCode SDK | VS Code Extension API | 1.85+ | VSCode 扩展开发 | 官方 API |
| 桌面框架 | Tauri | 1.5+ | 桌面应用 | Rust 后端，性能好，包体小 |
| 前端框架 | Vue 3 | 3.4+ | 桌面应用 UI | 熟悉度高，生态完善 |
| UI 组件库 | Element Plus | 2.4+ | 桌面应用组件 | 企业级组件库 |
| 状态管理 | Pinia | 2.1+ | 桌面应用状态 | Vue 3 官方推荐 |
| 后端语言 | TypeScript | 5.3+ | Node.js 工具链 | 统一语言栈 |
| API 风格 | RESTful | - | GitLab API 调用 | GitLab 原生支持 |
| 数据库 | - | - | 不需要 | 纯客户端架构 |
| 缓存 | localStorage/IndexedDB | - | 浏览器端缓存 | 浏览器原生支持 |
| 文件存储 | 本地文件系统 | - | 配置导出 | 客户端本地存储 |
| 认证 | GitLab Token | - | API 认证 | Personal Access Token |
| 前端测试 | Vitest | 1.0+ | 单元测试 | 快速，与 Vite 集成好 |
| E2E 测试 | Playwright | 1.40+ | 端到端测试 | 支持多浏览器 |
| 构建工具 | Vite | 5.0+ | 应用构建 | 快速的开发体验 |
| 打包工具 | Rollup | 4.0+ | 库打包 | Vite 底层，适合库开发 |
| 包管理 | pnpm | 8.0+ | 依赖管理 | 节省磁盘，支持 workspace |
| CI/CD | GitHub Actions | - | 自动化构建 | 免费，与 GitHub 集成 |
| 代码规范 | ESLint + Prettier | 最新 | 代码质量 | 统一代码风格 |
| CSS 框架 | UnoCSS | 0.58+ | 原子化 CSS | 高性能，按需生成 |

## 4. 数据模型（待完善）

_此部分将定义核心数据模型，包括：_
- MR（Merge Request）数据结构
- 用户配置模型
- 缓存数据结构
- GitLab API 响应类型

## 5. API 规范（待完善）

_此部分将定义 GitLab API 的封装接口_

## 6. 组件设计（待完善）

_此部分将详细说明各个组件的职责和接口_

## 7. 外部 API（待完善）

_此部分将记录使用的 GitLab API 端点_

## 8. 核心工作流（待完善）

_此部分将使用序列图展示关键用户流程_

## 9. 项目结构（待完善）

_此部分将展示详细的 monorepo 目录结构_

## 10. 开发工作流（待完善）

_此部分将定义本地开发设置和流程_

## 11. 部署架构（待完善）

_此部分将说明各端点的发布流程_

## 12. 安全和性能（待完善）

_此部分将定义安全策略和性能目标_

## 13. 测试策略（待完善）

_此部分将制定测试计划和标准_

## 14. 编码标准（待完善）

_此部分将定义项目特定的编码规范_

## 15. 错误处理（待完善）

_此部分将定义统一的错误处理策略_

## 16. 监控和可观测性（待完善）

_此部分将说明日志和监控方案_

---

*文档状态：初稿，待继续完善*
*最后更新：2024-12-19*
*下一步：完成数据模型和 API 规范部分*



